<html>
<head>
    <title>Generate Flower Images Per Conditions</title>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="./favicon.png" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="./assets/css/examples.css" />
</head>

<body>
    <nav class="navbar" style="background-color: #000000">
        <div class="app-header">
            <a href="">
                <img src="./logo.png" class="logo" />
            </a>
            <a class="title" href="" style="color: #f0ab3c">KNN avg Generator</a>
        </div>
    </nav>

    <div>Type conditions here:</div>

    <table>
        <tr>
            <td>Roundness</td>
            <td><input type="text" style="border:3px solid #F7730E;" value="0" id="testInput1" /></td>

            <td>Pistil Visibility</td>
            <td><input type="text" style="border:3px solid #F7730E;" value="0" id="testInput2" /></td>

            <td>Petal Quantity</td>
            <td><input type="text" style="border:3px solid #F7730E;" value="0" id="testInput3" /></td>

            <td>Size</td>
            <td><input type="text" style="border:3px solid #F7730E;" value="0" id="testInput4" /></td>
        </tr>
    </table>

    <button id="get-time" py-click="my_gen_function()" class="py-button">Generate</button>

    <p id="current-val"></p>
    <div id="test-output"></div>
    <div id="pandas-output"></div>

    <section class="pyscript">
        <div id="mpl"></div>
        <py-config>
            packages = [
                "matplotlib",
                "pandas",
            ]
            plugins = [
                "https://pyscript.net/latest/plugins/python/py_tutor.py"
            ]
        </py-config>

        <script type="py">
            import matplotlib.pyplot as plt
            import numpy as np
            import pandas as pd
            from pyodide.http import open_url
            from js import console

            def my_gen_function():
                test_x = get_np_conditions_vector()
                generated_img = predict(test_x)
                display_image(generated_img, test_x)

            url1 = "https://alyssacal24.github.io/KnnMiniProject/PD_conditions_train.csv"
            pd_conditions_train = pd.read_csv(open_url(url1)).to_numpy()

            url2 = "https://alyssacal24.github.io/KnnMiniProject/PD_imgs_np_train.csv"
            pd_imgs_np_train_np = pd.read_csv(open_url(url2)).to_numpy()

            def euclidean_distance(v1, v2):
                return np.sqrt(np.sum((v1 - v2) ** 2))

            def predict(test_x):
                distances = [euclidean_distance(test_x, x) for x in pd_conditions_train]
                k = 3
                k_neighbor_indices = np.argsort(distances)[:k]
                selected_imgs_to_avg = [pd_imgs_np_train_np[i].reshape((140, 39)) for i in k_neighbor_indices]
                avg_gen_img = np.mean(np.array(selected_imgs_to_avg), axis=0)
                avg_gen_img = avg_gen_img.astype(int)
                return avg_gen_img

            def get_np_conditions_vector():
                c1 = float(Element('testInput1').element.value)
                c2 = float(Element('testInput2').element.value)
                c3 = float(Element('testInput3').element.value)
                c4 = float(Element('testInput4').element.value)
                conditions_list = [c1, c2, c3, c4]
                np_conditions_list = np.array(conditions_list)
                np_conditions_list = np.expand_dims(np_conditions_list, axis=0)
                return np_conditions_list

            def display_image(image, conditions):
                str_conditions = np.array2string(conditions, precision=0, separator=',', suppress_small=True)
                str_conditions = str_conditions.replace(" ", "")
                str_conditions = str_conditions.replace("[", "")
                str_conditions = str_conditions.replace("]", "")
                fig, ax = plt.subplots()
                ax.imshow(image)
                ax.set_title(str_conditions)
                plt.colorbar(label="Colorbar", orientation="vertical")
                plt.show()

        </script>
    </section>
</body>
</html>
